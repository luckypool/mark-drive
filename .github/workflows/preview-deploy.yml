name: Preview Deploy

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or PR number to deploy'
        required: false
        default: ''
  issue_comment:
    types: [created]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # workflow_dispatch ã¯å¸¸ã«å®Ÿè¡Œã€issue_comment ã¯ PR ã« [preview] ã‚³ãƒ¡ãƒ³ãƒˆæ™‚ã®ã¿
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.issue.pull_request && contains(github.event.comment.body, '[preview]'))
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Resolve ref
        id: ref
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'issue_comment') {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });
              core.setOutput('ref', pr.data.head.ref);
              core.setOutput('pr_number', context.issue.number);
            } else {
              const input = '${{ github.event.inputs.ref }}';
              if (input && /^\d+$/.test(input)) {
                const pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: parseInt(input),
                });
                core.setOutput('ref', pr.data.head.ref);
                core.setOutput('pr_number', input);
              } else {
                core.setOutput('ref', input || context.ref);
                core.setOutput('pr_number', '');
              }
            }

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.ref }}

      - uses: oven-sh/setup-bun@v2

      - run: bun install --frozen-lockfile

      - name: Install Vercel CLI
        run: bun add -g vercel

      - name: Pull Vercel project settings
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Comment on PR
        if: steps.ref.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.ref.outputs.pr_number }},
              body: `ðŸš€ Preview deployed: ${{ steps.deploy.outputs.url }}`
            });
